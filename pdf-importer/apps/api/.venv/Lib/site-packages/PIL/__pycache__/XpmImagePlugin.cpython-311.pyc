            (_executionContext.IsPlatformAdmin ||
                (_executionContext.CustomerId.HasValue && x.CustomerId == _executionContext.CustomerId.GetValueOrDefault() &&
                    (_executionContext.IsCustomerAdmin || _executionContext.SiteIds.Contains(x.Id)))));
        });

        modelBuilder.Entity<PrinterModel>(b =>
        {
            b.ToTable("PrinterModels");
            b.HasKey(x => x.Id);
            b.Property(x => x.Manufacturer).HasMaxLength(120).IsRequired();
            b.Property(x => x.ModelName).HasMaxLength(120).IsRequired();
            b.Property(x => x.Series).HasMaxLength(120);
            b.Property(x => x.TonerBlackCode).HasMaxLength(80);
            b.Property(x => x.TonerCyanCode).HasMaxLength(80);
            b.Property(x => x.TonerMagentaCode).HasMaxLength(80);
            b.Property(x => x.TonerYellowCode).HasMaxLength(80);
            b.HasIndex(x => new { x.Manufacturer, x.ModelName }).IsUnique();
        });

        modelBuilder.Entity<Printer>(b =>
        {
            b.ToTable("Printers");
            b.HasKey(x => x.Id);
            b.Property(x => x.ExternalPrinterCode).HasMaxLength(64).IsRequired();
            b.Property(x => x.AssetTag).HasMaxLength(128);
            b.Property(x => x.Status).IsRequired();
            b.Property(x => x.IsDeleted).HasDefaultValue(false).IsRequired();
            b.Property(x => x.DeletedAtUtc);
            b.HasIndex(x => new { x.CustomerId, x.ExternalPrinterCode }).IsUnique().HasFilter("[IsDeleted] = 0");
            b.HasIndex(x => new { x.CustomerId, x.LocationId });
            b.HasIndex(x => x.PrinterModelId);
            b.HasOne<PrinterModel>()
                .WithMany()
                .HasForeignKey(x => x.PrinterModelId)
                .OnDelete(DeleteBehavior.SetNull);
            b.HasQueryFilter(x =>
                !x.IsDeleted &&
                (_executionContext.IsPlatformAdmin ||
                (_executionContext.CustomerId.HasValue && x.CustomerId == _executionContext.CustomerId.GetValueOrDefault() &&
                    (_executionContext.IsCustomerAdmin || _executionContext.SiteIds.Contains(x.LocationId)))));
        });

        modelBuilder.Entity<MailConnector>(b =>
        {
            b.ToTable("MailConnectors");
            b.HasKey(x => x.Id);
            b.Property(x => x.DisplayName).HasMaxLength(200);
            b.Property(x => x.Type).HasConversion<string>().HasMaxLength(16).IsRequired();
            b.Property(x => x.MailboxAddress).HasMaxLength(320).IsRequired();
            b.Property(x => x.Folder).HasMaxLength(256).IsRequired();
            b.Property(x => x.GraphTenantId).HasMaxLength(128);
            b.Property(x => x.GraphClientId).HasMaxLength(128);
            b.Property(x => x.GraphClientSecret).HasMaxLength(2048);
            b.Property(x => x.GraphDeltaToken).HasColumnType("nvarchar(max)");
            b.Property(x => x.ImapHost).HasMaxLength(255);
            b.Property(x => x.ImapUserName).HasMaxLength(320);
            b.Property(x => x.ImapPassword).HasMaxLength(2048);
            b.Property(x => x.SmtpEnabled).HasDefaultValue(false).IsRequired();
            b.Property(x => x.SmtpHost).HasMaxLength(255);
            b.Property(x => x.SmtpPort);
            b.Property(x => x.SmtpUseSsl).HasDefaultValue(true).IsRequired();
            b.Property(x => x.SmtpUserName).HasMaxLength(320);
            b.Property(x => x.SmtpPassword).HasMaxLength(2048);
            b.Property(x => x.SmtpFromEmail).HasMaxLength(320);
            b.Property(x => x.SmtpFromName).HasMaxLength(200);
            b.Property(x => x.SmtpClientBaseUrl).HasMaxLength(1024);
            b.Property(x => x.UpdatedAtUtc).IsRequired();
            b.Property(x => x.IsDeleted).HasDefaultValue(false).IsRequired();
            b.Property(x => x.DeletedAtUtc);
            b.HasIndex(x => new { x.Type, x.MailboxAddress }).IsUnique().HasFilter("[IsDeleted] = 0");
            b.HasIndex(x => x.Enabled);
            b.HasQueryFilter(x => !x.IsDeleted && _executionContext.IsPlatformAdmin);
        });

        modelBuilder.Entity<MailMessageRaw>(b =>
        {
            b.ToTable("MailMessages");
            b.HasKey(x => x.Id);
            b.Property(x => x.InternetMessageId).HasMaxLength(500).IsRequired();
            b.HasIndex(x => x.InternetMessageId).IsUnique();
            b.Property(x => x.FromAddress).HasMaxLength(500).IsRequired();
            b.Property(x => x.Subject).HasMaxLength(998).IsRequired();
            b.Property(x => x.Status).IsRequired();
            b.Property(x => x.DetectedExternalPrinterCode).HasMaxLength(64);
            b.Property(x => x.ConfidenceScore).IsRequired();
            b.Property(x => x.BodyText).HasColumnType("nvarchar(max)");
            b.HasIndex(x => new { x.CustomerId, x.DetectedExternalPrinterCode });

            b.HasMany(x => x.Attachments)
             .WithOne()
             .HasForeignKey(a => a.MailMessageRawId)
             .OnDelete(DeleteBehavior.Cascade);
            b.HasQueryFilter(x => _executionContext.IsPlatformAdmin || (_executionContext.CustomerId.HasValue && x.CustomerId == _executionContext.CustomerId.GetValueOrDefault()));
        });

        modelBuilder.Entity<MailAttachmentRaw>(b =>
        {
            b.ToTable("MailAttachments");
            b.HasKey(x => x.Id);
            b.Property(x => x.FileName).HasMaxLength(260).IsRequired();
            b.Property(x => x.ContentType).HasMaxLength(200).IsRequired();
            b.Property(x => x.Content).IsRequired();
            b.HasIndex(x => x.MailMessageRawId);
        });

        modelBuilder.Entity<MailSyncCursor>(b =>
        {
            b.ToTable("MailSyncCursors");
            b.HasKey(x => x.Id);
            b.Property(x => x.MailboxUser).HasMaxLength(320).IsRequired();
            b.Property(x => x.Folder).HasMaxLength(256).IsRequired();
            b.Property(x => x.DeltaLink).HasColumnType("nvarchar(max)");
            b.HasIndex(x => new { x.MailboxUser, x.Folder }).IsUnique();
        });

        modelBuilder.Entity<PrinterEvent>(b =>
        {
            b.ToTable("PrinterEvents");
            b.HasKey(x => x.Id);
            b.Property(x => x.Type).HasMaxLength(100).IsRequired();
            b.Property(x => x.Severity).HasMaxLength(32).IsRequired();
            b.Property(x => x.PayloadJson).HasColumnType("nvarchar(max)");
            b.HasIndex(x => new { x.CustomerId, x.PrinterId, x.OccurredAt });
            b.HasIndex(x => new { x.CustomerId, x.LocationId, x.OccurredAt });
            b.HasIndex(x => x.SourceMailId);
            b.HasQueryFilter(x => _executionContext.IsPlatformAdmin || (_executionContext.CustomerId.HasValue && x.CustomerId == _executionContext.CustomerId.GetValueOrDefault()));
        });
    }

    private void ApplySoftDeleteRules()
    {
        var now = DateTimeOffset.UtcNow;
        foreach (var entry in ChangeTracker.Entries<ISoftDeletable>().Where(x => x.State == EntityState.Deleted))
        {
            entry.State = EntityState.Modified;
    